---
title: TLS Routing Migration
description: How to upgrade exising Teleport cluster to a single-port TLS routing mode
---

Starting from version `8.0` Teleport supports TLS routing. In this mode of
operation all client connections are wrapped in TLS and multiplexed on one
Teleport proxy port.

This way of running a Teleport cluster has multiple benefits compared to the
"traditional" approach with each protocol served on its own port:

- Simpler network policy configurations since all clients connect to Teleport
  proxy over a single port.
- Communication between any client and Teleport proxy is authenticated by
  mutual TLS.
- Users are able to tunnel protocols that may normally be blocked on the
  internal network e.g. SSH.

Existing clusters upgraded to `8.0` will not utilize TLS routing by default and
keep working in backwards-compatibility mode. Follow this guide to migrate your
Teleport installation to TLS routing.

## Considerations

For TLS routing to work, Teleport proxy needs to terminate all client
connections.

As such, it will not work with application load balancers (such as AWS ALB) or
load balancers that do TLS termination. Use plain TCP passthrough load balancers
(such as AWS NLB) to take advantage of TLS routing.

## Step 1/6. Upgrade to Teleport `8.0`

Download Teleport `8.0` or later from the [downloads page](https://goteleport.com/teleport/download)
or your enterprise portal and follow the standard [upgrade procedure](./upgrading.mdx).
Make sure to upgrade both root and leaf clusters.

Pre-8.0 cluster configurations are fully backwards compatible with TLS routing
and existing trusted cluster and reverse tunnel agent connections won't be
affected.

## Step 2/6. Enable `multiplex` proxy listener mode

Update your root cluster auth server's configuration to set proxy listener mode
to "multiplex":

```yaml
auth_service:
  proxy_listener_mode: multiplex
```

This setting will indicate to the clients (such as `tsh` or reverse tunnel
agents) that they should connect to the web proxy port using TLS routing.

## Step 3/6. Reconnect trusted clusters

If you're already multiplexing trusted cluster connections on the web proxy
port (i.e. `web_proxy_addr` and `tunnel_addr` have the same port in your
trusted cluster resources), you can skip this step.

Otherwise, update your trusted clusters to point both `web_proxy_addr` and
`tunnel_addr` to the root cluster's web proxy address and recreate them:

```yaml
kind: trusted_cluster
version: v2
metadata:
   name: "root"
spec:
   enabled: true
   web_proxy_addr: root.example.com:443
   tunnel_addr: root.example.com:443
   ...
```

## Step 4/6. Reconnect reverse tunnel agents

Restart all SSH, Kubernetes, application and database agents that connect to
the cluster's proxy over reverse tunnels.

This will make them reconnect to the cluster in TLS routing mode.

## Step 5/6. Update OpenSSH config

If you're using OpenSSH client `ssh` with the config generated by `tsh config`
to connect to nodes within your Teleport cluster, you need to regenerate the
config.

Run `tsh config` command again so it generates SSH config compatible with SSH
routing setup.

## Step 6/6. Disable legacy listeners

At this point, all root cluster's clients connect to its web proxy port in TLS
routing mode. The final step is to instruct the Teleport proxy not to create
legacy listeners for SSH, reverse tunnels, Kubernetes and database clients by
default.

Add `version: v2` to your proxy's configuration and remove all listen addresses
except for `web_listen_addr`:

```yaml
version: v2
proxy_service:
  enabled: "yes"
  web_listen_addr: 0.0.0.0:443
  ...
```

Config version `v2` will prevent other listeners from being created unless
they are explicitly set in the proxy service configuration.

## Rollback

To go back to the legacy separate listeners mode, perform the following steps:

1. Set `version: v1` in the proxy configuration and restart the proxy to make
   it create legacy listeners.
2. Set `proxy_listener_mode: separate` in auth service configuration to make
   clients connect to the legacy listeners.
3. Reconnect trusted clusters and other reverse tunnel agents as described
   above.
4. If using OpenSSH client, regenerate SSH config using `tsh config` command.

## Next steps

* Learn how TLS routing [works](INSERT ARCHITECTURE LINK).
